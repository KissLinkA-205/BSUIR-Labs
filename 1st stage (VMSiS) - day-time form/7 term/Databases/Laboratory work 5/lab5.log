Microsoft Windows [Version 10.0.19044.2251]
(c) Корпорация Майкрософт (Microsoft Corporation). Все права защищены.

D:\PostgreSQL\14\bin>psql -U postgres Tourist_Agency
Password for user postgres:
psql (14.5)
WARNING: Console code page (866) differs from Windows code page (1251)
         8-bit characters might not work correctly. See psql reference
         page "Notes for Windows users" for details.
Type "help" for help.

Tourist_Agency=# \! chcp 1251
Текущая кодовая страница: 1251

-- 1) Выводится название, страна, категория и цена тура, рейтинги оставленных отзывов и средняя оценка пользователей на тур.
-- Рассматриваются отзывы, оставленные в временной период с 20 ноября 2022 года до 30 ноября 2022 года.
-- Данные отсортированы в алфавитном порядке по названию тура.
Tourist_Agency=# SELECT tours.title                            "Tour title",
Tourist_Agency-#        tours.country                          "Country",
Tourist_Agency-#        tours.category                         "Category",
Tourist_Agency-#        tours.price                            "Price",
Tourist_Agency-#        string_agg(reviews.rating::text, ', ') "Ratings",
Tourist_Agency-#        AVG(reviews.rating) as                 "Average rating"
Tourist_Agency-# FROM public.tours
Tourist_Agency-#          INNER JOIN public.reviews ON reviews.tour_id = tours.id
Tourist_Agency-#          INNER JOIN public.clients ON clients.id = reviews.client_id
Tourist_Agency-# WHERE reviews.adding_date >= '20.11.2022'
Tourist_Agency-#   AND reviews.adding_date <= '30.11.2022'
Tourist_Agency-# GROUP BY tours.id
Tourist_Agency-# ORDER BY tours.title ASC;
        Tour title         | Country | Category |   Price    | Ratings  |   Average rating
---------------------------+---------+----------+------------+----------+--------------------
 Незабываемый тур в Турцию | Турция  | пляжный  | 1 200,00 ? | 8, 3, 10 | 7.0000000000000000
 Путешествие в Египет      | Египет  | пляжный  |   500,00 ? | 7, 10    | 8.5000000000000000
(2 rows)


-- 2) Выводится имя, фамилия и электронная почта клиента, а также завершенные туры, в которых побывал клиент и
-- общая стоимость всех завершенных туров. Рассматривается 2022 год.
-- Данные отсортированы в алфавитном порядке по общей потраченной сумме.
-- В конце добавляется общая выручка турагентства от выполненных заказов.
Tourist_Agency=# SELECT clients.name                  "Name",
Tourist_Agency-#        clients.surname               "Surname",
Tourist_Agency-#        clients.email                 "Email",
Tourist_Agency-#        string_agg(tours.title, ', ') "Tours",
Tourist_Agency-#        SUM(orders.total_cost) as     "Total price"
Tourist_Agency-# FROM public.clients
Tourist_Agency-#          INNER JOIN public.orders ON clients.id = orders.client_id
Tourist_Agency-#          INNER JOIN public.tours ON tours.id = orders.tour_id
Tourist_Agency-# WHERE orders.issue_date >= '01.01.2022'
Tourist_Agency-#   AND orders.issue_date <= '31.12.2022'
Tourist_Agency-#   AND orders.status = 'завершен'
Tourist_Agency-# GROUP BY clients.id
Tourist_Agency-# UNION
Tourist_Agency-# SELECT '', '', '', 'Total revenues', SUM(orders.total_cost)
Tourist_Agency-# FROM orders
Tourist_Agency-# WHERE orders.status = 'завершен'
Tourist_Agency-# ORDER BY "Total price";
   Name    |  Surname  |           Email           |           Tours           | Total price
-----------+-----------+---------------------------+---------------------------+-------------
 Глеб      | Соколов   | sokolov.g@gmail.com       | Путешествие в Египет      |    660,00 ?
 Анастасия | Астапенко | nastia2.astap@tut.by      | Путешествие в Египет      |    700,00 ?
 Александр | Попов     | alex.popov@mail.ru        | Незабываемый тур в Турцию |  1 500,00 ?
 Иван      | Быков     | ivan_b@gmail.com          | Незабываемый тур в Турцию |  1 500,00 ?
 Екатерина | Новикова  | katya.novikova7@gmail.com | Незабываемый тур в Турцию |  1 580,00 ?
           |           |                           | Total revenues            |  5 940,00 ?
(6 rows)


-- 3) Выводится название, страна и тип тура, а также перечисляются возможные даты отправления в тур.
-- Около тура выводится количество транспортов, доступных в туре. Рассматривается 2022 год.
-- Данные отсортированы в алфавитном порядке по названию тура.
Tourist_Agency=# SELECT tours.title                                       "Tour",
Tourist_Agency-#        tours.country                                     "Country",
Tourist_Agency-#        tours.category                                    "Category",
Tourist_Agency-#        string_agg(transports.departure_date::text, ', ') "Dates",
Tourist_Agency-#        COUNT(transports.id) as                           "Number of transports"
Tourist_Agency-# FROM public.tours
Tourist_Agency-#          INNER JOIN public.tours_transports ON tours_transports.tour_id = tours.id
Tourist_Agency-#          INNER JOIN public.transports ON transports.id = tours_transports.transport_id
Tourist_Agency-# WHERE transports.departure_date >= '01.01.2022'
Tourist_Agency-#   AND transports.departure_date <= '31.12.2022'
Tourist_Agency-# GROUP BY tours.id
Tourist_Agency-# ORDER BY tours.title ASC;
              Tour               |  Country  |    Category     |                           Dates                            | Number of transports
---------------------------------+-----------+-----------------+------------------------------------------------------------+----------------------
 Горнолыжный центр Силичи        | Беларусь  | горнолыжный     | 2022-12-26, 2022-12-27, 2022-12-29, 2022-12-31, 2022-12-31 |                    5
 Незабываемый отдых на Шри-Ланке | Шри-Ланка | пляжный         | 2022-12-31                                                 |                    1
 Незабываемый тур в Турцию       | Турция    | пляжный         | 2022-11-04, 2022-11-17                                     |                    2
 Отдых в Батуми                  | Грузия    | пляжный         | 2022-11-19, 2022-12-12                                     |                    2
 Отдых в Египте                  | Египет    | пляжный         | 2022-11-26, 2022-12-27                                     |                    2
 Путешествие в Египет            | Египет    | пляжный         | 2022-11-20, 2022-11-26, 2022-12-01                         |                    3
 Санаторий Плисса                | Беларусь  | оздоровительный | 2022-11-20                                                 |                    1
(7 rows)


-- 4) Выводится имя, фамилия и электронная почта клиента, статус заказа, общая стоимость заказа,
-- а также перечень номеров паспортов, участвующих в заказе. Рассматриваются заказы со статусом,
-- отличным от «завершен» и «отменен». Данные отсортированы в алфавитном порядке по статусу заказа.
Tourist_Agency=# SELECT clients.name                             "Name",
Tourist_Agency-#        clients.surname                          "Surname",
Tourist_Agency-#        clients.email                            "Email",
Tourist_Agency-#        orders.status                            "Status",
Tourist_Agency-#        orders.total_cost                        "Total cost",
Tourist_Agency-#        string_agg(passports.number::text, ', ') "Passports"
Tourist_Agency-# FROM public.orders
Tourist_Agency-#          INNER JOIN public.clients ON clients.id = orders.client_id
Tourist_Agency-#          INNER JOIN public.orders_passports ON orders_passports.order_id = orders.id
Tourist_Agency-#          INNER JOIN public.passports ON passports.id = orders_passports.passport_id
Tourist_Agency-# WHERE orders.status != 'завершен'
Tourist_Agency-#   AND orders.status != 'отменен'
Tourist_Agency-# GROUP BY orders.id, clients.id
Tourist_Agency-# ORDER BY orders.status ASC;
   Name    |   Surname   |           Email           |     Status     | Total cost |            Passports
-----------+-------------+---------------------------+----------------+------------+---------------------------------
 Ярослав   | Сорока      | y.vas45@mail.ru           | в процессе     |   660,00 ? | MC1412384
 Павел     | Януш        | pyanysh@mail.ru           | в процессе     |   210,00 ? | MC1243759
 Иван      | Быков       | ivan_b@gmail.com          | обрабатывается |   103,00 ? | MP1102484
 Эмилия    | Балановская | 9emilia_b@tut.by          | обрабатывается | 1 930,00 ? | ME2340023, MC6823025, MP8435838
 Анастасия | Астапенко   | nastia2.astap@tut.by      | подтвержден    | 1 200,00 ? | MP2340285
 Полина    | Кузнецова   | polinak@gmail.com         | подтвержден    | 1 260,00 ? | MK0014123
 Екатерина | Новикова    | katya.novikova7@gmail.com | подтвержден    |   980,00 ? | MC4850234
 Иван      | Быков       | ivan_b@gmail.com          | подтвержден    |   103,00 ? | ME6924014
(8 rows)


-- 5) Выводится имя, фамилия и электронная почта клиента, а также количество заказов. Рассматривается 2022 год. 
-- Данные отсортированы в алфавитном порядке по количеству заказов. 
-- В конце добавляется общее количество заказов пользователей.
Tourist_Agency=# SELECT clients.name        "Name",
Tourist_Agency-#        clients.surname     "Surname",
Tourist_Agency-#        clients.email       "Email",
Tourist_Agency-#        COUNT(orders.id) as "Number of orders"
Tourist_Agency-# FROM public.clients
Tourist_Agency-#          INNER JOIN public.orders ON clients.id = orders.client_id
Tourist_Agency-# WHERE orders.issue_date >= '01.01.2022'
Tourist_Agency-#   AND orders.issue_date <= '31.12.2022'
Tourist_Agency-# GROUP BY clients.id
Tourist_Agency-# UNION
Tourist_Agency-# SELECT '', '', 'Total number of orders', COUNT(orders.id)
Tourist_Agency-# FROM orders
Tourist_Agency-# ORDER BY "Number of orders";
   Name    |   Surname   |           Email           | Number of orders
-----------+-------------+---------------------------+------------------
 Павел     | Януш        | pyanysh@mail.ru           |                1
 Глеб      | Соколов     | sokolov.g@gmail.com       |                1
 Максим    | Карпов      | m.karpov67@gmail.com      |                1
 Александр | Попов       | alex.popov@mail.ru        |                1
 Ярослав   | Сорока      | y.vas45@mail.ru           |                1
 Полина    | Кузнецова   | polinak@gmail.com         |                2
 Екатерина | Новикова    | katya.novikova7@gmail.com |                2
 Анастасия | Астапенко   | nastia2.astap@tut.by      |                2
 Эмилия    | Балановская | 9emilia_b@tut.by          |                2
 Иван      | Быков       | ivan_b@gmail.com          |                3
           |             | Total number of orders    |               16
(11 rows)
